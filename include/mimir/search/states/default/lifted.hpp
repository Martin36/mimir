#ifndef MIMIR_SEARCH_STATES_DEFAULT_LIFTED_HPP_
#define MIMIR_SEARCH_STATES_DEFAULT_LIFTED_HPP_

#include "../default.hpp"


namespace mimir
{

/**
 * Implementation class
 *
 * The lifted state builder extends the builder base memory layout as follows:
 *  __________________________________
 * |                |          |      |
 * | data_size_type | state_id | TODO |
 * |________________|__________|______|
 *
 *
*/
template<>
class Builder<WrappedStateTag<DefaultStateTag, LiftedTag>>
    : public BuilderBase<Builder<WrappedStateTag<DefaultStateTag, LiftedTag>>>
    , public StateBuilderBase<Builder<WrappedStateTag<DefaultStateTag, LiftedTag>>> {
    state_id_type m_id;

    /* Implement BuilderBase interface */
    data_size_type calculate_size_impl() const {
        return sizeof(state_id_type);
    }

    void finish_impl() {
        this->m_buffer.write(m_id);
    }

    friend class BuilderBase<Builder<WrappedStateTag<DefaultStateTag, LiftedTag>>>;

    /* Implement StateBuilderBase interface */
    void set_id_impl(state_id_type id) { m_id = id; }

    friend class StateBuilderBase<Builder<WrappedStateTag<DefaultStateTag, LiftedTag>>>;
};


/**
 * Implementation class
 *
 * Reads the memory layout generated by the lifted state builder.
*/
template<>
class View<WrappedStateTag<DefaultStateTag, LiftedTag>>
    : public ViewBase<View<WrappedStateTag<DefaultStateTag, LiftedTag>>>
    , public StateViewBase<View<WrappedStateTag<DefaultStateTag, LiftedTag>>> {
private:
    static constexpr size_t s_id_offset =  sizeof(data_size_type);
    static constexpr size_t s_data_offset = sizeof(data_size_type) + sizeof(state_id_type);

    /* Implement ViewBase interface */
    [[nodiscard]] size_t get_offset_to_representative_data_impl() const { return s_data_offset; }

    // Give access to the private interface implementations.
    template<typename>
    friend class ViewBase;

    /* Implement SearchNodeViewBase interface */
    [[nodiscard]] state_id_type get_id_impl() const {
        return read_value<state_id_type>(this->get_data() + s_id_offset);
    }

    // Give access to the private interface implementations.
    template<typename>
    friend class StateViewBase;

public:
    explicit View(char* data) : ViewBase<View<WrappedStateTag<DefaultStateTag, LiftedTag>>>(data) { }
};


}  // namespace mimir

#endif  // MIMIR_SEARCH_STATES_DEFAULT_LIFTED_HPP_
